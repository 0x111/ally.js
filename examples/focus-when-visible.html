<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Focus An Element Once It Became Visible</title>
  <style>
    #example-container {
      margin: 0;
    }

    .thing {
      box-sizing: border-box;
      width: 300px;
      height: 30px;
      border: 1px solid red;
      background: #CCFFFF;
      opacity: 0.5;
      -webkit-transform: translate3d(-300px, -30px, 0px);
              transform: translate3d(-300px, -30px, 0px);
      transition: -webkit-transform 0.1s 0s ease-in-out;
      transition:         transform 0.1s 0s ease-in-out;
    }

    #container {
      width: 400px;
      height: 100px;
      overflow: hidden;
      border: 2px solid silver;
    }

    div:focus {
      background: #AAA;
    }

    .move {
      -webkit-transform: translate3d(60px, 50px, 0px);
              transform: translate3d(60px, 50px, 0px);
      transition: transform 2s 0s ease-out;
    }

  </style>
</head>
<body>

  <h1>Focus An Element Once It Became Visible</h1>
  <p>
    ally.js provides the method <code>ally/when/focusable</code> to set focus to an element once it became visible.
    An element is considered visible when <code>ally/is/visible</code> determined the element can be rendered and
    <a href="visible-area.html"><code>ally/util/visible-area</code></a> identified the element as being fully
    rendered in the viewport.
  </p>
  <p>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement.focus"><code>Element.focus()</code></a> scrolls the
    element into view if it isn't already. In situations where content is not revealed immediately, but through a transition
    or animation <code>ally/when/focusable</code> will set focus to the element once it is fully visible on screen -
    regardless of the method you used to hide/show the element. Additionally to the visibility, the function will also wait
    for the element to become focusable.
  </p>
  <p>
    The function executes exactly once, meaning it won't focus the target element every time it comes into view. Focusing is
    aborted should another element have gotten focus prior to the target element coming fully into view. The target element
    is focused immediately if it is already fully visible.
  </p>


  <h2 id="usage">Usage</h2>
  <pre>// load when/focusable
var focusWhenVisible = require('ally/when/focusable');

// register focus to be applied when the element is focusable and visible
var handle = focusWhenVisible({
  // context can be String (query selector), Node, Array of Nodes, NodeList, HTMLCollection
  context: document.getElementById('element-to-focus'),
  // when/focus compatible callback function
  callback: function(element) {
    // the context is passed back as element for convenience
    element.focus();
    // upon return of the callback handle.disengage() is executed internally,
    // to prevent disengaging, to keep polling, return false
  },
  // [optional] percentage of area of the context element to be visible in the viewport
  // default is 1, be careful with lower values because browsers 
  // may scroll the element the into view
  area: 1,
});

// kick of your revealing mechanism
element.style.top = '100px';

// abort focusing the target element
// no operation performed if focus was already given
// the method is called automatically should any element
// gain focus prior to the callback being executed
handle.disengage();</pre>


  <h2 id="example">Example</h2>
  <p>
    Press the "start" button below.
    An element will be animated into view and focused once it is fully visible (yet before the transition ended).
    Press <kbd>ESC</kbd> to programmatically abort focusing the target element.
    Click on the "abort" button to focus another element during transition to prevent the target element from getting focused.
  </p>

  <hr>
  <button type="button" id="activate">loading…</button>
  <button type="button">abort</button>
  <hr>
  <div id="example-container">
    <div id="container">
      <div class="thing" tabindex="1"></div>
    </div>
  </div>
  <pre id="example-log"></pre>


  <script src="../node_modules/requirejs/require.js"></script>
  <script src="main.js"></script>
  <script>
    require(['ally/when/focusable', 'ally/map/keycode'], function(focusWhenVisible, keyCode) {
      var button = document.getElementById('activate');
      var log = document.getElementById('example-log');
      var element = document.querySelector('.thing');
      var handle;

      document.addEventListener('focus', function(event) {
        if (event.target === element) {
          handle = null;
          log.textContent += 'focused!\n';
          return;
        }

        if (event.target === button || !element.classList.contains('move')) {
          return;
        }

        log.textContent += 'another element was focused…\n';
      }, true);
      
      document.addEventListener('transitionend', function() {
        log.textContent += 'transition ended!\n';
      }, true);

      document.addEventListener('keydown', function(event) {
        if (event.keyCode === keyCode.escape && handle) {
          log.textContent += 'aborted focus when visible!\n';
          handle.disengage();
        }
      }, true);

      button.addEventListener('click', function() {
        if (element.classList.contains('move')) {
          element.classList.remove('move')
          button.textContent = 'start';
          return;
        }

        handle = focusWhenVisible({
          context: element,
          callback: function(element) {
            element.focus();
          },
        });

        log.textContent = 'started…\n';
        button.textContent = 'reset';
        element.classList.add('move');
      }, true);

      button.textContent = 'start';
    });
  </script>
</body>
</html>
